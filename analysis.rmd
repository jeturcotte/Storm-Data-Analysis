---
title: "Storm Data Analysis"
author: "J.E. Turcotte"
date: "March 21, 2016"
output: html_document
---

# Synopsis

# Data Processing

```{r loading the data}
library(ggplot2)
library(dplyr)
storms <- read.csv("repdata-data-StormData.csv.bz2")
```

## Slimming Memory

First, a somewhat inconsequential move to slim down memory usage for the analysis.  Here we will concern ourselves with when, roughly where, type and damages.

```{r}
storms <- storms[,c("BGN_DATE","STATE","EVTYPE","F","MAG","FATALITIES","INJURIES","PROPDMG","PROPDMGEXP","CROPDMG","CROPDMGEXP","REMARKS","REFNUM")]
```

## Repairing the EVTYPEs

A brief examination of the data set provided shows that the entry method behind EVTYPE was not strongly controlled. As a result, there are myriad (if often consisting of a population of 1) rows about the same event type that are simply spelled differently, wrongly, or with difference cases.  For example, there are 5 smaples of 'small hail', one sample of 'Small Hail' and 47 samples of 'SMALL HAIL.'

To that end, the following steps will attempt to clean this up a bit.  First by normalizing case and removing unnecessary punctuation or spaces:

```{r removing caps pluralization and punctuation }
total_evtypes_before_any_fixes <- nrow(data.frame(table(storms$EVTYPE)))
storms$EVTYPE <- tolower(storms$EVTYPE)
total_evtypes_after_lowercase <- nrow(data.frame(table(storms$EVTYPE)))
storms$EVTYPE <- gsub("s$", "", storms$EVTYPE)
storms$EVTYPE <- gsub("^\\s*", "", storms$EVTYPE)
storms$EVTYPE <- gsub("[/\\]", " ", storms$EVTYPE)
storms$EVTYPE <- gsub("[[:punct:]]", "", storms$EVTYPE)
```

Just setting every EVTYPE to lowercase dropped the variety from `r total_evtypes_before_any_fixes` down to `r total_evtypes_after_lowercase`.  That's not insignificant.  

Having looked over these EVTYPES repeatedly while doing this, I did notice a section of items that seemed to be getting special attention without being particularly explicit as to what they were.  I don't want to abandoned them just yet, so I'm isolating them below, as previous attempts to grep through the REMARKS field proved deleteriously long.

```{r set aside subset of summary entries}
summaries <- storms[grep("summary", storms$EVTYPE),]
summaries$REMARKS <- as.character(summaries$REMARKS)
summary(summaries)
```

There appear to be, out of `r nrow(summaries)` records, `r nrow(summaries[grep("thunder",summaries$REMARKS),])` that mention thunderstorms.  So let's look at those that don't:

```{r find any summary entry that does not mention thunderstorms}
summaries[!grepl("thunder",tolower(summaries$REMARKS)),]$REMARKS
```

So we have entries referring to a flood and to a blizzard.  All the rest mention thunderstorms.  Many, however, including the flood-only reference ALSO reference 'later entries.'  In other words, other rows.  Counting both brings the danger of double-counting data.  So, let's take a look, first:

```{r checking out summaries for useful data}
peak_fatalities_from_summaries <- max(summaries$FATALITIES)
peak_injuries_from_summaries <- max(summaries$INJURIES)
peak_crop_damage_from_summaries <- max(summaries$CROPDMG)
peak_property_damage_from_summaries <- max(summaries$PROPDMG)
```

So, given that we have `r peak_fatalities_from_summaries` fatalities, `r peak_injuries_from_summaries` injuries, `r peak_crop_damage_from_summaries` crop damage, and `r peak_propery_damage_from_summaries` in property damages, these summaries appear to be distinctly and just that, containing no data for what are otherwise described as events of significance.  We will dispense with them.

```{r adjust storms data according to summary entries}
storms$EVTYPE <- gsub("^.*summary.*$", "to be ignored", storms$EVTYPE)
rm(summaries)
```

Given that we'd seen a lot of numbers in the names of these EVTYPES, let's look at any that may be left:

```{r looking at numeric references}
data.frame(table(storms[grep("\\s*[a-z]*\\d+",storms$EVTYPE),]$EVTYPE))
total_evtypes_before_dropping_numbers <- nrow(data.frame(table(storms$EVTYPE)))
```

As individual sets of values, they are not terribly valuable for analysis, and so this next substitution in EVTYPE should help lump these back together a little bit:

```{r culling numeric references}
storms$EVTYPE <- gsub("\\s*[a-z]*\\d+", "", storms$EVTYPE)
total_evtypes_after_dropping_numbers <- nrow(data.frame(table(storms$EVTYPE)))
```

Just doing that dropped the total unique EVTYPES from `r total_evtypes_before_dropping_numbers` to `r total_evtypes_after_dropping_numbers` in total.

Further, from the above subset, we see the need to collapse some descriptions into their proper categories.  The difficulty here is that some mention multiple categories, re: 'thunderstorm winds' for example.  This forces this anaylsis to make a value judgement.  Since a thunderstorm, for example, is the expected amalgamation of multiple types of potential damage (e.g., wind, tornado, rain, lightning, and hail), this study prefers to recognize it as an event type, separate from special alternative mentions of said types that they typify.

```{r unifying particularly obvious storm references}
storms$EVTYPE <- gsub("^.*blizz?ard.*$", "blizzard", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*chill.*$", "wind chill", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*tornado.*$", "tornado", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*funnel.*$", "funnel cloud", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*spout.*$", "waterspout", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*burst.*$", "microburst", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*lightn?ing.*$", "lightning", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*flood.*$", "flood", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*break.*$", "flood", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*dam failure.*$", "flood", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*high water.*$", "flood", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*rising water.*$", "flood", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*[fv]og.*$", "fog", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*surge.*$", "storm surge", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*swell.*$", "storm surge", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*trop.*$", "tropical storm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*hail.*$", "hail", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*tstm.*$", "thunderstorm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*wall.*$", "thunderstorm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*thund.*$", "thunderstorm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*wi?nd.*$", "wind", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*gustnado.*$", "wind", storms$EVTYPE)
total_evtypes_after_easy_fixes <- nrow(data.frame(table(storms$EVTYPE)))
```

The process above has helped narrow things a bit... down from `r total_evtypes_after_dropping_numbers` distinct hand-written EVTYPEs to `r total_evtypes_after_easy_fixes`.  That's still too many.  Please also note that these differ slightly from the categories recommended by the documentation provided for the collection OF this kind of data, insofar as the EVTYPE field shows all the signs of having been typed in, leaving room for improper interpretation, typos, and the like.  The categories I am salvaging from this will be close but ruled by what has been found in this data, instead.

```{r counting references to snow and ice}
total_evtypes_mentioning_snow <- nrow(data.frame(table(storms[grep("snow",storms$EVTYPE),]$EVTYPE)))
total_evtypes_mentioning_ice <- nrow(data.frame(table(storms[grep("ice",storms$EVTYPE),]$EVTYPE)))
```

There are `r total_evtypes_mentioning_snow` remaining types mentioning snow, and another `r total_evtypes_mentioning_ice` mentioning ice, and...

```{r looking at references to snow and ice}
data.frame(table(storms[grep("snow|ice",storms$EVTYPE),]$EVTYPE))
```

... some overlap between the two, this analysis chooses to prioritize ice over snow (and throw in sleet as distinct.)

```{r separating snow ice and sleet}
storms$EVTYPE <- gsub("^.*ice.*$", "icy conditions", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*icy.*$", "icy conditions", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*glaze.*$", "icy conditions", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*snow.*$", "snow", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*sleet.*$", "sleet", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*heavy mix.*$", "sleet", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*mixed precip.*$", "sleet", storms$EVTYPE)
data.frame(table(storms[grep("wint?er",storms$EVTYPE),]$EVTYPE))
```

Note: the NOAA's definition of *mixed precipitation* (http://forecast.weather.gov/glossary.php?word=mixed%20precipitation) fails over to sleet when not otherwise specified, so I have done the same.

Now, A quick look at mentions of winter do not betray anything that seems inappropriate to lumping them together as well.

```{r cleaning up winter referenes}
storms$EVTYPE <- gsub("^.*winte?r.*$", "winter storm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*mix.*$", "winter storm", storms$EVTYPE)
data.frame(table(storms[grep("freez|cool|cold",storms$EVTYPE),]$EVTYPE))
```

Meanwhile, still on the cold weather tack, it looks like we DO need to make a distinction between a freeze (cold snap) and freezing rain.  Then again, looking at *cool* and *cold* most reference particular cold, which is probably inferrable as *freezing* as well.  I'm also using a value judgement to toss in references to hypothermia under *freezing temperatures*.

```{r cleaning up freezing and frost references}
storms$EVTYPE <- gsub("^.*freezing.*$", "freezing rain", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*freeze.*$", "freezing temperatures", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*frost.*$", "freezing temperatures", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*cold.*$", "freezing temperatures", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*hypo.*$", "freezing temperatures", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*cool.*$", "unusually cool", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*low temp.*$", "unusually cool", storms$EVTYPE)
total_evtypes_after_freezing <- nrow(data.frame(table(storms$EVTYPE)))
```

In similar vein, let us box up any mention of *warmth* or *heat*, while preserving mention of droughts or odd *dryness* (which could lead to *drought* but may not have reached those levels yet):

```{r cleaning up hot and dry references}
storms$EVTYPE <- gsub("^.*drou.*$", "drought", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*dry.*$", "unusually dry", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*below normal precipitation.*$", "unusually dry", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*warm.*$", "unusually warm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*heat.*$", "extreme heat", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*hyper.*$", "extreme heat", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*dust.*$", "dusty weather", storms$EVTYPE)
data.frame(table(storms[grep("^(?!freezing ).*rain|wet",storms$EVTYPE, perl=T),]$EVTYPE))
```

Down to `r total_evtypes_after_freezing` evtypes, when we began with `r total_evtypes_before_any_fixes`.  Given that there are still more to go, and the recent mention of freezing rain, I've just looked at any mentions of rain or general wetness, above.  Given that many of the references to 'wet' seem to infer periods of time in excess of any given storm, they will be kept separate.

```{r cleaning up nonfreezing references to wet and rain}
storms$EVTYPE <- gsub("^.*wet.*$", "prolonged damp", storms$EVTYPE)
storms$EVTYPE <- gsub("^(?!freezing).*rain.*$", "rain", storms$EVTYPE, perl=T)
storms$EVTYPE <- gsub("^.*precip.*$", "rain", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*shower.*$", "rain", storms$EVTYPE)
total_evtypes_after_rain <- nrow(data.frame(table(storms$EVTYPE)))
data.frame(table(storms$EVTYPE))
```

Now for a quick look at all `r total_evtypes_after_rain` EVTYPEs remaining.  The list is a bit long (apologies), but still significantly shorter than what we began with, and without any *noticeable* cases of miscategorization.  We'll be trying to clean up easily discernible edge cases here.  Further, *wall clouds* generally are part of a thunderstorm, we'll categorize them as such.

```{r coalescing some rarer events}
storms$EVTYPE <- gsub("^.*volc.*$", "volcanic activity", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*smoke.*$", "smoke", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*slide.*$", "landslide", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*slump.*$", "landslide", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*avalan.*$", "avalanche", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*fire.*$", "wildfire", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*hurr.*$", "hurricane", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*typhoon.*$", "hurricane", storms$EVTYPE)
```

Note: The data itself seems to force an overlap between *hurricane* (atlantic storm) and *typhoon* (pacific storm.)  I'd have preferred to keep them separate since how the USA is set up to deal with either may be difference... but the above made that relatively improbable.  So they are put together.

There seems to be some emphasis on 'urban sml stream fld' so we'll preserve that as well, separate from other flooding.  Futher, since so many had referenced urban, and some that DO reference urban do NOT reference floods, per se, we'll choose to believe they meant to:

```{r localized flooding}
storms$EVTYPE <- gsub("^.*stre?a?m.*$", "localized flood", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*urban.*$", "localized flood", storms$EVTYPE)
```

Let's also engage with references to nonflood water conditions:

```{r rough waters}
storms$EVTYPE <- gsub("^rough.*$", "rough water", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*seiche.*$", "rough water", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*surf.*$", "rough water", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*high sea.*$", "rough water", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*high wave.*$", "rough water", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*high tide.*$", "high tide", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*blowout tide.*$", "high tide", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*low tide.*$", "low tide", storms$EVTYPE)
```

Now this anaylsis needs to explore any mention of extremities.  Because the terminology used is relative in nature (e.g., a record low of 40F in the middle of August does not constitute *freeze temperatures*) I'll have to categorize under *unsually cool*, instead.  Vice versa, as well.

```{r record temperatures}
storms$EVTYPE <- gsub("^.*high temp.*$", "unusually warm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*record high.*$", "unusually warm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*hot.*$", "unusually warm", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*low temp.*$", "unusually cool", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*record low.*$", "unusually cool", storms$EVTYPE)
data.frame(table(storms[grep("record",storms$EVTYPE),]$EVTYPE))
```

But, notice that we now have a not unappreciate number of records referring to record temperatures.  Let's see what consequences we have from each:

```{r counting up damages from records that remain}
peak_fatalities_from_record_temperatures <- max(storms[grep("record",storms$EVTYPE),]$FATALITIES)
peak_crop_damage_from_record_temperatures <- max(storms[grep("record",storms$EVTYPE),]$CROPDMG)
peak_property_damage_from_record_temperatures <- max(storms[grep("record",storms$EVTYPE),]$PROPDMG)
```

The results being, `r peak_fatalities_from_record_temperatures` total maximum fatalities, `r peak_crop_damage_from_record_temperatures` incident maximum crop damage, and `r peak_property_damage_from_record_temperatures` in property damage.  A cursory examinination of the columns of data available, there appears to be no reliable algorithmic way to discern whether these were highs or lows, and given the above maximum, I have to elect to render these records mute to this study.

```{r opting to eliminate these as ignorable}
storms$EVTYPE <- gsub("^.*record.*$", "to be ignored", storms$EVTYPE)
storms$EVTYPE <- gsub("^.*other.*$", "to be ignored", storms$EVTYPE)
```

Finally, this leaves just a handful of outlier EVTYPEs that either can't significantly alter this study or are not quickly identifiable as any other particular type.  The choice made at this juncture is to isolate any that have a count of less than 10 instances, and stale them for elimination:

```{r ignore tiny EVTYPE result sets}
evtype_names <- data.frame(table(storms$EVTYPE))
storms[storms$EVTYPE %in% evtype_names[evtype_names$Freq < 10,]$Var1,]$EVTYPE <- 'to be ignored'
storms$EVTYPE <- as.factor(storms$EVTYPE)
```

And that leaves us with `r nrow(data.frame(table(storms$EVTYPE)))` distinct event types to consider for the rest of our analysis.

## Normalizing the Damages

Looking more closely at the columns involved in damages, which is what we need to look at to study the consequences of these incidents, we need to know the following from the documentation attached to the data we're studying:

*Estimates should be rounded to three significant digits, followed by an alphabetical character signifying the magnitude of the number, i.e., 1.55B for $1,550,000,000. Alphabetical characters used to signify magnitude include “K” for thousands, “M” for millions, and “B” for billions.*

But...

```{r}
storms %>% group_by(PROPDMGEXP) %>% summarize(population=length(REFNUM))
storms %>% group_by(CROPDMGEXP) %>% summarize(population=length(REFNUM))
```

... we have a few more levels with values than merely *K*, *M*, and *B*, BUT these (including the unnamed factor) represent the overwhelming majority of records, so we'll discount the rest, given that this examine is to determine the most costly and the most deadly of weather incident types.